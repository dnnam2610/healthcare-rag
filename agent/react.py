
"""
    - Ch·ªß ƒë·ªÅ: lich tiem chung cho be duoi 1 tuoi L·ªãch ti√™m ch·ªßng cho b√© d∆∞·ªõi 1 tu·ªïi theo khuy·∫øn c√°o c·ªßa WHO L·ªãch ti√™m ch·ªßng cho b√© d∆∞·ªõi 1 tu·ªïi theo khuy·∫øn c√°o c·ªßa WHO bao g·ªìm c√°c lo·∫°i v·∫Øc xin quan tr·ªçng m√† tr·∫ª c·∫ßn ƒë∆∞·ª£c ti√™m ƒë·ªß li·ªÅu, ƒë√∫ng l·ªãch trong nh·ªØng nƒÉm th√°ng ƒë·∫ßu ƒë·ªùi. N·∫øu b·ªè l·ª° m·ªôt trong nh·ªØng lo·∫°i v·∫Øc xin d∆∞·ªõi ƒë√¢y, tr·∫ª c√≥ th·ªÉ m·∫•t ƒëi c∆° h·ªôi ƒë∆∞·ª£c b·∫£o v·ªá to√†n di·ªán v√† tr·ªçn ƒë·ªùi b·∫±ng v·∫Øc xin . Vi√™m m√†ng n√£o do n√£o m√¥ c·∫ßu tu√Ωp B,C Varicella (H√†n Qu·ªëc)
    - Ch·ªß ƒë·ªÅ: u xuong\nC√°c lo·∫°i u x∆∞∆°ng √°c t√≠nh\n1. Sarcoma x∆∞∆°ng\nUng th∆∞ x∆∞∆°ng t·∫°o x∆∞∆°ng l√† m·ªôt lo·∫°i u x√°c t√≠nh, x·∫£y ra khi c√°c t·∫ø b√†o t·∫°o ra kh·ªëi u √°c t√≠nh thay v√¨ x∆∞∆°ng m·ªõi. B·ªánh u x∆∞∆°ng √°c t√≠nh n√†y ph·∫ßn l·ªõn x·∫£y ra ·ªü nh·ªØng v·ªã tr√≠ x∆∞∆°ng ƒë·∫ßu g·ªëi ho·∫∑c x∆∞∆°ng vai v√† c√°c v√πng x∆∞∆°ng d√†i. ( 3 )\nNg∆∞·ªùi b·ªánh c√≥ nh·ªØng tri·ªáu ch·ª©ng s∆∞ng ƒëau quanh khu v·ª±c c√≥ kh·ªëi u x∆∞∆°ng √°c t√≠nh, c∆∞·ªùng ƒë·ªô c∆°n ƒëau cao, c√≥ ·∫£nh h∆∞·ªüng ƒë·∫øn ƒëi l·∫°i, sinh ho·∫°t h·∫±ng ng√†y.\n2. Sarcoma Ewing\nB·ªánh u x∆∞∆°ng √°c t√≠nh, ung th∆∞ c√≥ t√≠nh ch·∫•t gia ƒë√¨nh Ewing Sarcoma th∆∞·ªùng g·∫∑p ·ªü ƒë·ªëi t∆∞·ª£ng thanh thi·∫øu ni√™n v√† thanh ni√™n. D√π v·∫≠y, b·ªánh Sarcoma Ewing c≈©ng c√≥ th·ªÉ x·∫£y ra ·ªü tr·∫ª em tr√™n 5 tu·ªïi. T·∫ø b√†o ung th∆∞ c·ªßa Sarcoma Ewing xu·∫•t ph√°t t·ª´ c√°c h·ªëc t·ªßy, ƒë√≥ l√† ph·∫ßn h·ªëc x∆∞∆°ng n∆°i t·ªßy x∆∞∆°ng ƒë∆∞·ª£c t·∫°o ra. Ngo√†i ra Sarcoma Ewing c≈©ng c√≥ th·ªÉ ph√°t tri·ªÉn trong c√°c m√¥ m·ªÅm nh∆∞ m·ª°, c∆° v√† m·∫°ch m√°u.\n3. Sarcoma s·ª•n\nB·ªánh Sarcoma s·ª•n, c√≤n ƒë∆∞·ª£c g·ªçi l√† ung th∆∞ s·ª•n, ti·∫øn tri·ªÉn t·ª´ nh·ªØng kh·ªëi u x∆∞∆°ng √°c t√≠nh ph·ªï bi·∫øn. Ung th∆∞ s·ª•n thu·ªôc lo·∫°i ung th∆∞ nguy√™n ph√°t, c√≥ t√≠nh ph√°t tri·ªÉn v√† di cƒÉn, th∆∞·ªùng x·∫£y ra ·ªü x∆∞∆°ng ch·∫≠u, h√¥ng v√† vai. B·ªánh g·ªìm 3 giai ƒëo·∫°n b·ªánh v√† nguy c∆° di cƒÉn ƒë·∫øn c√°c c∆° quan kh√°c kh√° cao.\n4. Ung th∆∞ di cƒÉn x∆∞∆°ng\nUng th∆∞ di cƒÉn x∆∞∆°ng l√† d·∫°ng ung th∆∞ th·ª© ph√°t, x·∫£y ra v·ªõi nh·ªØng tr∆∞·ªùng h·ª£p ƒëang c√≥ t·∫ø b√†o ung th∆∞ t·∫°i c∆° quan kh√°c.\nB·ªánh c√≥ th·ªÉ l√† bi·∫øn ch·ª©ng t·ª´ c√°c ung th∆∞ nh∆∞:\n- Ung th∆∞ th·∫≠n\n- Ung th∆∞ v√∫\n- Ung th∆∞ tuy·∫øn ti·ªÅn li·ªát\n- Ung th∆∞ ph·ªïi\n- Ung th∆∞ tuy·∫øn gi√°p\n5. B·ªánh ƒëa u t·ªßy\nB·ªánh ƒëa u t·ªßy l√† ung th∆∞ c·ªßa t∆∞∆°ng b√†o, ph√° h·ªßy c√°c x∆∞∆°ng xung quanh b·∫±ng c√°ch x√¢m l·∫•n v√† g√¢y t·ªïn th∆∞∆°ng ch√∫ng. B·ªánh g√¢y ra c√°c t√¨nh tr·∫°ng t·ªïn th∆∞∆°ng m·ª° trong x∆∞∆°ng, g√£y x∆∞∆°ng, suy th·∫≠n ho·∫∑c nhi·ªÖm tr√πng.\nNh·ªØng tri·ªáu ch·ª©ng ph·ªï bi·∫øn ·ªü b·ªánh u x∆∞∆°ng √°c t√≠nh ƒëa u t·ªßy l√† ƒëau x∆∞∆°ng dai d·∫≥ng, ƒë·∫∑c bi·ªát ·ªü ph·∫ßn l∆∞ng v√† ng·ª±c.
    - Ch·ªß ƒë·ªÅ: u xuong\nC√°c lo·∫°i u x∆∞∆°ng l√†nh t√≠nh\n1. U x∆∞∆°ng s·ª•n\nU x∆∞∆°ng s·ª•n l√† lo·∫°i u l√†nh t√≠nh ph·ªï bi·∫øn nh·∫•t, chi·∫øm kho·∫£ng 40% c√°c tr∆∞·ªùng h·ª£p u x∆∞∆°ng l√†nh t√≠nh. T√¨nh tr·∫°ng u x∆∞∆°ng s·ª•n l√† do s·ª± b·∫•t th∆∞·ªùng tƒÉng tr∆∞·ªüng c·ªßa s·ª•n v√† x∆∞∆°ng, c·ª• th·ªÉ l√† tƒÉng tr∆∞·ªüng qu√° nhi·ªÅu. Ch√≠nh v√¨ th·∫ø m√† b·ªánh th∆∞·ªùng x·∫£y ra v·ªõi nh·ªØng ng∆∞·ªùi n·∫±m trong ƒë·ªô tu·ªïi ph√°t tri·ªÉn, t·ª´ 13 ‚Äì 25 tu·ªïi. Th·ªëng k√™ c·ªßa H·ªçc vi·ªán Ph·∫´u thu·∫≠t Ch·ªânh h√¨nh Hoa K·ª≥ (AAOS) c≈©ng k·∫øt lu·∫≠n u x∆∞∆°ng s·ª•n th∆∞·ªùng r∆°i v√†o nh·ªØng tr∆∞·ªùng h·ª£p tr·∫ª em v·ªã th√†nh ni√™n v√† thanh ni√™n.\nC√°c kh·ªëi u ·ªü x∆∞∆°ng s·ª•n h√¨nh th√†nh ·ªü v·ªã tr√≠ ƒë·∫ßu x∆∞∆°ng d√†i nh∆∞ x∆∞∆°ng c√°nh tay ho·∫∑c x∆∞∆°ng ch√¢n.\n2. U x∆° kh√¥ng c·ªët h√≥a\nU x∆° kh√¥ng c·ªët h√≥a l√† m·ªôt lo·∫°i u x∆∞∆°ng, h√¨nh th√†nh do s·ª± t·ªïn th∆∞∆°ng x∆° h√≥a c·ªßa x∆∞∆°ng v·ªõi tri·ªáu ch·ª©ng c·∫≠n l√¢m s√†ng l√† ti√™u v·ªè x∆∞∆°ng c√≥ xu·∫•t hi·ªán t·ªïn th∆∞∆°ng. ƒê√¢y l√† lo·∫°i u l√†nh t√≠nh.\nNg∆∞·ªùi b·ªã u x∆° kh√¥ng c·ªët h√≥a s·∫Ω c√≥ nh·ªØng ·ªï khuy·∫øt kh√° nh·ªè b√™n trong x∆∞∆°ng. Nh·ªØng ·ªï khuy·∫øt n√†y s·∫Ω ƒë∆∞·ª£c l·∫•p ƒë·∫ßy b·∫±ng m√¥ x∆° thay v√¨ m√¥ x∆∞∆°ng nh∆∞ ng∆∞·ªùi kh·ªèe m·∫°nh.\n3. U t·∫ø b√†o kh·ªïng l·ªì\nU t·∫ø b√†o kh·ªïng l·ªì c√≤n ƒë∆∞·ª£c g·ªçi l√† u ƒë·∫°i b√†o ho·∫∑c u h·ªßy c·ªët b√†o, l√† m·ªôt trong nh·ªØng ki·ªÉu u l√†nh t√≠nh ph·ªï bi·∫øn. Tuy nhi√™n, b·ªánh c√≥ th·ªÉ ti·∫øn tri·ªÉn thanh u t·∫ø b√†o kh·ªïng l·ªì √°c t√≠nh, v√¨ th·∫ø y√™u c·∫ßu ng∆∞·ªùi b·ªánh c·∫ßn c√≥ s·ª± ch√∫ t√¢m ƒëi·ªÅu tr·ªã b·ªánh h∆°n c√°c u lo·∫°i u x∆∞∆°ng l√†nh t√≠nh kh√°c.\nU t·∫ø b√†o kh·ªïng l·ªì di·ªÖn ra ·ªü v·ªã tr√≠ ƒë·∫ßu x∆∞∆°ng d√†i, th∆∞·ªùng g·∫∑p l√† ƒë·∫ßu tr√™n x∆∞∆°ng ch√†y, x∆∞∆°ng ƒë√πi, x∆∞∆°ng quay v√† ƒë·∫ßu d∆∞·ªõi x∆∞∆°ng c√πng. B·ªánh g·ªìm 3 giai ƒëo·∫°n:\n- U nh·ªè l√†nh t√≠nh, v·ªè x∆∞∆°ng b·ªã ph√° h·ªßy.\n- U tƒÉng k√≠ch th∆∞·ªõc, v·ªè x∆∞∆°ng b·ªã t·ªïn th∆∞∆°ng v√† m·ªèng h∆°n b√¨nh th∆∞·ªùng\n- U tƒÉng sinh ƒë√°ng k·ªÉ, ·∫£nh h∆∞·ªüng x·∫•u ƒë·∫øn c√°c ph·∫ßn m·ªÅm xung quanh. ƒê·ªìng th·ªùi m·∫°ch m√°u c≈©ng tƒÉng sinh nhi·ªÅu.\n4. U s·ª•n\nU s·ª•n l√† t√¨nh tr·∫°ng u nang s·ª•n ph√°t tri·ªÉn b√™n trong t·ªßy x∆∞∆°ng, c√≥ c√°c lo·∫°i l√† u nguy√™n b√†o s·ª•n, u x∆° s·ª•n v√† u n·ªôi s·ª•n. U n·ªôi s·ª•n th∆∞·ªùng x·∫£y ra nh∆∞ d·∫°ng u x∆∞∆°ng l√†nh t√≠nh, trong khi u nguy√™n b√†o s·ª•n t∆∞∆°ng ƒë·ªëi hi·∫øm g·∫∑p .\nU n·ªôi s·ª•n c√≥ th·ªÉ x·∫£y ra ·ªü m·ªçi l·ª©a tu·ªïi v√† ƒë·ªëi t∆∞·ª£ng. B·ªánh th∆∞·ªùng kh√¥ng c√≥ c√°c tri·ªáu ch·ª©ng ƒëi k√®m, nh∆∞ng s·ª± ph√°t tri·ªÉn c·ªßa kh·ªëi u s·∫Ω g√¢y s∆∞ng v√† ƒëau t·∫°i v·ªã tr√≠ t·ªïn th∆∞∆°ng.\nƒê√¢y l√† m·ªôt d·∫°ng kh·ªëi u l√†nh t√≠nh, tuy nhi√™n trong tr∆∞·ªùng h·ª£p ng∆∞·ªùi b·ªánh c√≥ nhi·ªÅu kh·ªëi u n·ªôi s·ª•n, nh·∫•t l√† c√≥ x·∫£y ra hi·ªán t∆∞·ª£ng ch·∫£y m√°u m√¥ m·ªÅm th√¨ s·∫Ω c√≥ nguy c∆° m·∫Øc ung th∆∞ n·ªôi s·ª•n cao h∆°n ng∆∞·ªùi kh√°c.\n5. Nang x∆∞∆°ng ph√¨nh m·∫°ch\nNang x∆∞∆°ng ph√¨nh m·∫°ch l√† s·ª± t·ªïn th∆∞∆°ng nang ·ªü c√°c v√πng h√†nh x∆∞∆°ng c·ªßa x∆∞∆°ng d√†i, ph·∫ßn l·ªõn x·∫£y ra v·ªõi nh·ªØng ng∆∞·ªùi tr√™n 25 tu·ªïi. T·ªïn th∆∞∆°ng do nang x∆∞∆°ng ph√¨nh m·∫°ch c√≥ th·ªÉ k√©o d√†i t·ª´ v√†i tu·∫ßn ƒë·∫øn v√†i nƒÉm tr∆∞·ªõc khi ƒë∆∞·ª£c ch·∫©n ƒëo√°n.\nC√°c nang x∆∞∆°ng b·ªã t·ªïn th∆∞∆°ng c√≥ xu h∆∞·ªõng ph√°t tri·ªÉn ch·∫≠m h∆°n b√¨nh th∆∞·ªùng, ƒë·ªìng th·ªùi x·∫£y ra t√¨nh tr·∫°ng ph·ªìng x∆∞∆°ng.
    """ 
import os
import sys
sys.path.append(os.path.abspath(os.path.join(os.path.dirname(__file__), '..')))
from typing import List
from llms import LLMs
from prompts import AGENT_PROMPT
from retriever import TopKRetriever, Candidate
from config import GROQ_API_KEY, VECTOR_SIZE, QDRANT_API_KEY, QDRANT_URL
import re

retriever = TopKRetriever(
        type='qdrant',               
        embeddingName="BAAI/bge-m3",
        vector_size=VECTOR_SIZE,
        qdrant_api=QDRANT_API_KEY,
        qdrant_url=QDRANT_URL
    )

def initial_retrieve(query: str, top_k: int = 3):
    return retriever.search(query=query, limit=top_k)
class Agent:
    def __init__(self, client: LLMs, system_prompt: str = AGENT_PROMPT) -> None:
        self.client = client
        self.system_prompt = system_prompt
        self.messages: list = []
        if self.system_prompt:
            self.messages.append({"role": "system", "content": system_prompt})

    def __call__(self, message=""):
        if message:
            self.messages.append({"role": "user", "content": message})
        result = self.execute()
        self.messages.append({"role": "assistant", "content": result})
        return result

    def execute(self):
        completion = self.client.generate_content(self.messages)
        return completion
    

def extend_candidates(old_candidates: List[Candidate], new_candidates: List[Candidate]):
    results = list(old_candidates)
    seen_ids = {oc.id for oc in old_candidates}

    for nc in new_candidates:
        if nc.id not in seen_ids:
            seen_ids.add(nc.id)
            results.append(nc)

    return results

def retrieve_more_information(query: str):
    new_candidates = retriever.search(query=query, limit=3)
    return new_candidates

def format_observation(candidates: List[Candidate]) -> str:
    lines = []
    for c in candidates:
        lines.append(f"- {c.content}")
    return "\n".join(lines)

def end_loop(text:str):
    return "end_loop"

def loop(
    agent: Agent,
    query: str,
    initial_candidates: List[Candidate],
    max_iterations: int = 5
):
    
    is_sufficient = False
    old_candidates = list(initial_candidates)

    observation = format_observation(old_candidates)

    next_prompt = f"""
Observation:
{observation}

Question:
{query}
"""

    for step in range(max_iterations):
        print(f"\n===== LOOP ITERATION {step + 1} =====")

        result = agent(next_prompt)
        print(result)

        # Parse Action
        action = re.findall(
            r"Action:\s*([a-z_]+)\s*:\s*(.*)",
            result,
            re.IGNORECASE
        )

        # N·∫øu kh√¥ng c√≥ Action ‚Üí coi nh∆∞ Answer cu·ªëi
        if not action:
            is_sufficient = True
            print("\n‚úÖ No action found ‚Üí assume sufficient.")
            break

        tool_name, tool_arg = action[0]
        tool_name = tool_name.lower().strip()
        
        # Agent quy·∫øt ƒë·ªãnh ƒë·ªß th√¥ng tin
        if tool_name == "end_loop":
            is_sufficient = True
            print("\nüõë Agent decided information is sufficient.")
            break

        # Agent y√™u c·∫ßu th√™m th√¥ng tin
        if tool_name == "retrieve_more_information":
            print("\nüîÑ Retrieving more information...")

            new_candidates = retrieve_more_information(tool_arg)
            print("=== New RETRIEVAL ===")
            for c in new_candidates:
                print(f"[{c.id}] {c.content[:80]}...")
            print("=========================")

            old_candidates = extend_candidates(
                old_candidates=old_candidates,
                new_candidates=new_candidates
            )

            observation = format_observation(old_candidates)

            next_prompt = f"""
                        Observation:
                        {observation}

                        Question:
                        {query}
                    """
        else:
            print("‚ö†Ô∏è Unknown tool")
            break

    print("\n===== LOOP FINISHED =====")
    
    return old_candidates, is_sufficient


if __name__ == '__main__':
    client = LLMs(
        type="online",
        model_name="chatgroq",
        api_key=GROQ_API_KEY,
        model_version="llama-3.3-70b-versatile",
        base_url="https://api.groq.com"
    )

    agent = Agent(client=client, system_prompt=AGENT_PROMPT)

    query = "ƒêau ƒë·∫ßu, cƒÉng th·∫≥ng do c√¥ng vi·ªác, suy gi·∫£m tr√≠ nh·ªõ kho·∫£ng g·∫ßn m·ªôt nƒÉm ph·∫£i l√†m sao?"

    initial_candidates = initial_retrieve(query, top_k=3)

    print("=== INITIAL RETRIEVAL ===")
    for c in initial_candidates:
        print(f"[{c.id}] {c.content[:80]}...")
    print("=========================")

    candidates = loop(
        agent=agent,
        query=query,
        initial_candidates=initial_candidates,
        max_iterations=5
    )